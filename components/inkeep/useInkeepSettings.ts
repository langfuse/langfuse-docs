import type {
  InkeepAIChatSettings,
  InkeepSearchSettings,
  InkeepBaseSettings,
  InkeepModalSettings,
  AIChatDisclaimerSettings,
} from "@inkeep/uikit";
import { useTheme } from "nextra-theme-docs";
import { openChat } from "../supportChat";
import { InkeepCallbackEvent } from "@inkeep/uikit";
import { type PostHog, usePostHog } from "posthog-js/react";

const customAnalyticsCallback = (
  event: InkeepCallbackEvent,
  posthog: PostHog
): void => {
  const { interactionType } = event.commonProperties;
  posthog.capture(`inkeep:${event.eventName}`, {
    interactionType,
  });
};

type InkeepSharedSettings = {
  baseSettings: InkeepBaseSettings;
  aiChatSettings: InkeepAIChatSettings;
  searchSettings: InkeepSearchSettings;
  modalSettings: InkeepModalSettings;
};

const useInkeepSettings = (): InkeepSharedSettings => {
  const { resolvedTheme } = useTheme();
  const posthog = usePostHog();

  const baseSettings: InkeepBaseSettings = {
    apiKey: process.env.NEXT_PUBLIC_INKEEP_API_KEY!,
    integrationId: process.env.NEXT_PUBLIC_INKEEP_INTEGRATION_ID!,
    organizationId: process.env.NEXT_PUBLIC_INKEEP_ORGANIZATION_ID!,
    primaryBrandColor: "#E11312", // your brand color, widget color scheme is derived from this
    organizationDisplayName: "Langfuse",
    // ...optional settings
    colorMode: {
      forcedColorMode: resolvedTheme, // to sync dark mode with the widget
    },
    logEventCallback: (event) => customAnalyticsCallback(event, posthog),
    theme: {
      components: {
        SearchBarTrigger: {
          defaultProps: {
            size: "shrink", // 'expand' 'compact' 'shrink' 'medium'
            variant: "subtle", // 'emphasized' 'subtle',
          },
        },
      },
    },
  };

  const modalSettings: InkeepModalSettings = {
    // optional settings
    defaultView: "AI_CHAT", // chat should also be the default for the regular search
  };

  const searchSettings: InkeepSearchSettings = {
    placeholder: "Search...",
  };

  const disclaimerSettings: AIChatDisclaimerSettings = {
    isDisclaimerEnabled: true,
    disclaimerLabel: "AI-generated response",
    disclaimerTooltip:
      "This response is generated by AI and may contain inaccuracies or errors. Please reach out to support if you need assistance.",
  };

  const aiChatSettings: InkeepAIChatSettings = {
    // optional settings
    chatSubjectName: "Langfuse",
    botAvatarSrcUrl: "/icon256.png", // use your own bot avatar
    introMessage:
      "Hi! I'm Langfuse's AI assistant trained on documentation, help articles, and other content. How can I help you today?",
    shouldShowCopyChatButton: true,
    disclaimerSettings,
    includeAIAnnotations: {
      shouldEscalateToSupport: true,
    },
    aiAnnotationPolicies: {
      shouldEscalateToSupport: [
        {
          threshold: "STANDARD", // "STRICT" or "STANDARD"
          action: {
            type: "SHOW_SUPPORT_BUTTON",
            label: "Contact Support",
            icon: { builtIn: "LuUsers" },
            action: {
              type: "INVOKE_CALLBACK",
              callback: (args) => {
                const draftMessage =
                  "I tried to get answers via the AI chat but was unable to. My questions were:\n\n" +
                  args.messages
                    .filter((message) => message.role === "user")
                    .map((message) => message.content)
                    .join("\n");
                openChat(draftMessage);
              },
              shouldCloseModal: false,
            },
          },
        },
      ],
    },
    getHelpCallToActions: [
      {
        name: "Chat with us",
        type: "INVOKE_CALLBACK",
        callback: () => openChat(),
        icon: {
          builtIn: "IoChatbubblesOutline",
        },
      },
      {
        name: "GitHub Discussions",
        url: "https://langfuse.com/gh-support",
        icon: {
          builtIn: "FaGithub",
        },
      },
      {
        name: "Community Discord",
        url: "https://langfuse.com/discord",
        icon: {
          builtIn: "FaDiscord",
        },
      },
    ],
    quickQuestions: [
      "How can Langfuse help me?",
      "How to use the Python decorator for tracing?",
      "How to set up LLM-as-a-judge evals?",
    ],
  };

  return { baseSettings, aiChatSettings, searchSettings, modalSettings };
};

export default useInkeepSettings;
